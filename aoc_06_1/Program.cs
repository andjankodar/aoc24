// See https://aka.ms/new-console-template for more information
using System.Data;

var input = """
.......................#...................#....#..#......#.................#.#..#........................#.#..............#.....#
................#.#.......#..#.......#.................................................................................#.##.......
............#..............#......................#...#.....#...#..........##.........#.....#.....................................
..#...#......................................#............................#..................#..........#..#......................
....#........#.#....................#..........#.....#.............#..#............................#..................#......#....
..........................................................#................#............................................#.........
..#............................#.....#...........................#...........#........##...........................#..#...........
.....................#...........................#.#..............#......................................#.........#....#.....#...
.#...#.#.................#....................#...............................................................#.#..........#......
....#....................................#...........................................#.....#..........#...........................
.......................#..........#..............#......#....#.......#........................................#.#.................
......#...........................................................#...#............#.................#............................
.......#.................#..#.....................#...............................................................................
..............#....................#.#..........#........#......#................#.................#..........#...................
#.#.......................................#.........................#...................................#.........................
...#.........................................................................................#................#..................#
#.....#....#............................................................#.........................#..................#.#..........
.#.....#.#.......#.#..................#.#......................#.......#.....#..#..................##.....#.......#...#...........
....#.........#.................................#..........#........#...............#................#...................#....#...
.................#...............#...#.................#.................................................#........................
....#...#...............................#..................................................#..........#................#.....#....
...........#........#....#.......#...#..........#...............#.....#.....#.....#..........#....................................
............#.........#.................#................#.................#.#..................................................#.
............#......................................#...................................................................#..........
...........#....#.....................................................................................#............#..........#...
..........#........................................#.............#.................#........................#..#.......#........#.
......#.............................#.................##..................................#.....................#.................
.#.................................#.............................................#.................##.....#..............#......#.
.........................#..............................#..........#...........#....#................#......................#.....
.......#...................#......##........................#.........#...........................................................
......................................................................##...........#................#.............................
....#...................................##...............................................#........................................
...##.....#..#........#.................#..............................................................#..........................
........##......#....................#..............................#......................#...................#..................
.........................................................#.......................................................#.#..............
..........#.............................#.........#...............#................#.#.........#..........................#.#.....
....................#...................#..#.......................................................#..........#...............#...
...........................................................#........................#.........#........#..........................
.......#..............#......#.................................#...................##...........................#.........#.......
#...#...............................................................................................................#.............
................................#..#....#............#...........#..................#.............................#...............
....................#..............#.........#.................................#.............#..##................................
#...#..................................................................................#.....#...........#........................
........#...........#........#...#..................#.....#....#.........#.........................#...........................#..
.............#...#...................................................................#...........#................................
.............#........................................#...#.............#..............................#..#.........#.............
...#.................................................................................#.............#..........................##..
...#..............................................................................................................................
................#.........#..................................#...................#................................................
...#................#...#.#.....................#...........#..................................#........#....#......#.............
..........................#.....................#..#...................................##........................................#
#........................#...............................................#........#..#..........#...........................#.....
.#............#.#..............................................................#...........#......................................
......#..................................................................#.......#..............................#...#....#........
........#........................#.........#.............#.....#..................................................................
...............................................................................#...........................................#......
........................#..................................#.....................................................#................
............................................................#..........................#.................#.......................#
.....................#..#.........................#..............#.............................#........#..............##......#..
.....................#.................................................#.......#............#........................#.......#....
......................#.....................................................#......#............................#.................
................................................................#...#..##..#.....................................#...............#
..............#..............................................................................................#....................
............................................#......#..........#...............................................................#...
....#.................................#..................................................................#..........##..#.........
............#.....#................................................................................#..........#.........#.........
.....................#......................................#.........#....................................................#....#.
.........................#...............................#...............................#....................#...................
.#.....................#.#.......................................#....#...........#.......................#.......................
.....................................................#.#..#......................................................................#
#..........#..........................#............................#.............#..................#.............#...........#...
........#.........................................................................................................................
..........#.............#.........................................#................................................#..............
...........#................................#.................#...........................#.............................#.........
..................#.........................................#.#..................#...#...........#.......#..#.....................
........................................................#...#.......................................................#.............
.........................................................................#.......#..#.....#.......................................
............#..............................................................#.........#..............#.............#...............
#...#..........................................#...........#.....#.....................................#...............#..........
...........................#............#.........................................................................................
...#..........................................#.......................................................................#...........
..............#......#.....#.....................#..........................#.....................................................
.........................#....#...................#...#.......#..............................#........................#...........
.............................#............^.#................................................#......#..#.#...........#............
....................................................................................#...#.#...................................#...
.......................#..............................##..............................................#...........................
......................#...................................................#..........................................#............
......#........................................................................#.....................................#............
.......................#.............................#........................#...........#...........#............#...........#..
....#...............#..#......#....#..................#.............#.......#...............#.......................#.............
............#...#..................#..............................................................................................
....#.......#.................#.......................................................#..#......#.................................
.........#......#..........#......................#.....................#..................#.#....................................
...............##.......................................................#...#.............................#.......#...............
........................................................##...................#...#............#......#............................
...........#...#..............#.............................................................#...................#............#....
...............................................#.....#.....#......................................................................
.#....................#...#........#....................#.#.........#..........#................................#................#
.............#.....#..#....................................#.#...........#.................................................#..#.#.
......#.....................................#....................................................................#................
............................................................##......#.....................#.......#.....................#...#.....
.#.......#......................#.................................................................................................
................#....#......................#.........#...................#........#.......##.....#...............................
..#....#....................#............................................................#.#......#............#.....#.#....#.....
.................................#.................................................#.......#......................................
..................#...........#....#.....................#......#...............#..................#....................##........
.##...............................................#............#...........................#......................................
.............#...........#...........................#..#.......#...#..........#......................#..........#................
.......#...................................#.................#....#..............................................................#
........#....................................................#.................#.....#.........#.#................................
................#.................................#.....................#.....#.....#............................##...............
..............................................##.................#..##........#...........#............#..........................
....#......................................#...............................................................................#......
..#..............#.#................#..#..............#.......................................#.#.......#..............#......#..#
.....#..............................................................................................................#.......#.....
..#.......#.#..........#.......#..................................#..........#.......#.................#...........#...........#..
...............#.....#................#............#................#............#.....#.#........#...............................
....#.....................#................#.....................................#......................#.#.......#....#..........
........#...............#...#.....................................................#........#.........#.........#..................
...#......#..........................#.....#..........................##.......#....#.............................................
.............#................................#............................#.....#.......#......#................................#
.......................#............#..........................#..................................................................
.................................................#..............#...#...........................#.................................
......#...................#..............................................................................................#....#..#
....................................#......#.....................#..............#.......#...................#.....................
............#...................................#...........#........#........#...........................................##......
#...........#..........................#....................................#.........#................................#..........
......##..#...............................................................#...............................#.........#.............
.......................#.....#.........................#...#.........................#.....#..........#.#...#.....................
.......................#..#.....#.....#..........................#.........#.....#....................#.....#....................#
""";

var testInput = """
    ....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#..^.....
    ........#.
    #.........
    ......#...
    """;

var rows = input.Split("\r\n").Select(c => c.ToArray()).ToArray();
var position = GetStartingPosition();
var direction = "up";
var visited = new HashSet<(int row, int col)>();
visited.Add(position);

var turningPoints = new HashSet<(int row, int col, string direction)>();
visited.Add(position);

var outOfBounds = false;

(int row, int col) GetStartingPosition()
{
    for (int i = 0; i < rows.Length; i++)
    {
        for (int j = 0; j < rows[i].Length; j++)
        {
            if (rows[i][j] == '^')
            {
                return (i, j);
            }
        }
    }

    return (0, 0);
}

while(!outOfBounds)
{
    var nextPos = GetNextPos(position.row, position.col);
        
    if(WillGoOutOfBounds(nextPos.row, nextPos.col))
    {
        outOfBounds = true;
        break;
    }

    if (WillHitObstacle(nextPos.row, nextPos.col))
    {
        DoTurn();
        continue;
    }

    Move(nextPos.row, nextPos.col);
}

Console.WriteLine($"Visited: {visited.Count()} positions");

var allVisitedPositions = visited.ToArray();
var hitObstaclesFromDirection = new HashSet<(int row, int col, string direction)>();
var loops = 0;
reset();

// Part 2
for (int i = 0;i < allVisitedPositions.Length; i++)
{
    var newObstaclePos = allVisitedPositions[i];
    rows[newObstaclePos.row][newObstaclePos.col] = '#';

    while (!outOfBounds)
    {
        var nextPos = GetNextPos(position.row, position.col);

        if (WillGoOutOfBounds(nextPos.row, nextPos.col))
        {
            outOfBounds = true;
            break;
        }

        if (WillHitObstacle(nextPos.row, nextPos.col))
        {
            if(!hitObstaclesFromDirection.Add((nextPos.row, nextPos.col, direction)))
            {
                loops++;
                break;
            }

            DoTurn();
            continue;
        }

        Move(nextPos.row, nextPos.col);
    }

    hitObstaclesFromDirection.Clear();
    reset();
}

Console.WriteLine($"Possible loop positions {loops}");

void reset()
{
    rows = input.Split("\r\n").Select(c => c.ToArray()).ToArray();
    direction = "up";
    outOfBounds = false;
    position = GetStartingPosition();
}

bool WillGoOutOfBounds(int row, int col)
{
    return row < 0 || row >= rows.Length || col < 0 || col >= rows[row].Length;
}

bool WillHitObstacle(int row, int col)
{
    return rows[row][col] == '#';
}

void Move(int row, int col)
{
    position = (row, col);
    visited.Add((row, col));
}

(int row, int col) GetNextPos(int row, int col)
{
    switch(direction)
    {
        case "up":
            return (row - 1, col);
        case "right":
            return (row, col + 1);
        case "down":
            return (row+1, col);
        case "left":
            return (row, col-1);
    }

    return (0, 0);
}

void DoTurn()
{
    switch (direction)
    {
        case "up":
            direction = "right";
            break;
        case "right":
            direction = "down";
            break;
        case "down":
            direction = "left";
            break;
        case "left":
            direction = "up";
            break;
    }
}


